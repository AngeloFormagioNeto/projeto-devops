  deploy-to-vercel:
    needs: push-to-registry
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Copiar arquivos necessários para o diretório Terraform
    - name: Prepare Terraform files
      run: |
        mkdir -p terraform
        cp vercel.json terraform/
        cp Dockerfile terraform/

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.7.5

    - name: Terraform Init
      run: terraform -chdir=terraform init

    - name: Terraform Apply
      run: |
        terraform -chdir=terraform apply -auto-approve \
          -var="vercel_api_token=${{ secrets.VERCEL_API_TOKEN }}" \
          -var="docker_image=${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:$GITHUB_SHA" \
          -var="project_name=${{ env.VERCEL_PROJECT_NAME }}" \
          -var="github_repo=${{ github.repository }}"

    - name: Get Vercel URL
      id: vercel-url
      run: |
        URL=$(terraform -chdir=terraform output -raw vercel_url)
        echo "url=$URL" >> $GITHUB_OUTPUT

    - name: Show Vercel URL
      run: |
        echo "Deployed to: ${{ steps.vercel-url.outputs.url }}"